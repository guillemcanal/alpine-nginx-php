#!/bin/sh

PHP_BUILD_DEPS="re2c alpine-sdk php5-dev autoconf zlib-dev pcre-dev openssl-dev tidyhtml-dev@testing"

apk add $PHP_BUILD_DEPS

pecl_install ()
{
  local EXT_TYPE=$1
  local NAME=$2
  local VERSION=$3
  local CONFIGURE_ARGS=$(shift 3; echo $@)
  local PECL_URL="https://pecl.php.net/get/$NAME-$VERSION.tgz"

  cd /tmp
  wget $PECL_URL
  tar xzf $NAME-$VERSION.tgz || true
  cd /tmp/$NAME-$VERSION
  phpize
  ./configure $CONFIGURE_ARGS
  make
  make install
  echo "$EXT_TYPE=$NAME.so" >> /etc/php5/conf.d/$NAME.ini
}

# Install PHP extensions
pecl_install extension mongo 1.6.14
pecl_install zend_extension xdebug 2.3.3 --enable-xdebug


# Install Tidy from source :(
cd /tmp
wget http://php.net/distributions/php-5.6.23.tar.gz
tar xzf php-5.6.23.tar.gz
cd php-5.6.23/ext/tidy
sed -i 's/buffio.h/tidybuffio.h/' *.c
phpize
./configure
make
make install
echo "extension=tidy.so" >> /etc/php5/conf.d/tidy.ini

# Meminfo
mkdir -p /opt
cd /opt
git clone https://github.com/BitOne/php-meminfo.git
cd php-meminfo/extension
phpize
./configure
make
make install
echo "extension=meminfo.so" >> /etc/php5/conf.d/meminfo.ini
cd ../analyzer
composer update
ln -s /opt/php-meminfo/analyzer/bin/analyzer /sbin/analyzer

# Cleanup
rm -rf /tmp/*
apk del re2c alpine-sdk php5-dev autoconf zlib-dev pcre-dev openssl-dev